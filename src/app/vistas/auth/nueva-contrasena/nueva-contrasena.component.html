<ion-header [translucent]="true">
  <ion-toolbar>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="contenido-nueva-contrasena" [scrollY]="true">
  <div class="ion-padding contenedor-nueva-contrasena">
    
    
    <div *ngIf="!tokenVerificado && estaCargando" class="verificando-token">
      <p>Verificando enlace de recuperación...</p>
    </div>

    
    <div *ngIf="!contrasenaCambiada && tokenVerificado && tokenValido">
      <h2 class="titulo-nueva-contrasena">Nueva Contraseña</h2>
      <p class="descripcion-nueva-contrasena">
        Ingresa tu nueva contraseña. Asegúrate de que sea segura y fácil de recordar.
      </p>
      
      <form [formGroup]="formularioNuevaContrasena" (ngSubmit)="enviarFormulario()">
        
        <ion-item class="campo-formulario">
          <ion-label position="stacked">Nueva Contraseña</ion-label>
          <ion-input 
            [type]="mostrarContrasena ? 'text' : 'password'" 
            formControlName="nuevaContrasena"
            placeholder="Mínimo 6 caracteres">
          </ion-input>
          <ion-button 
            fill="clear" 
            slot="end" 
            (click)="alternarVisibilidadContrasena()"
            class="boton-ojo">
            <ion-icon [name]="mostrarContrasena ? 'eye-off' : 'eye'"></ion-icon>
          </ion-button>
        </ion-item>
        <div *ngIf="formularioNuevaContrasena.get('nuevaContrasena')?.invalid && formularioNuevaContrasena.get('nuevaContrasena')?.touched" 
             class="mensaje-error">
          <span *ngIf="formularioNuevaContrasena.get('nuevaContrasena')?.errors?.['required']">
            La contraseña es requerida
          </span>
          <span *ngIf="formularioNuevaContrasena.get('nuevaContrasena')?.errors?.['minlength']">
            La contraseña debe tener al menos 6 caracteres
          </span>
          <span *ngIf="formularioNuevaContrasena.get('nuevaContrasena')?.value && formularioNuevaContrasena.get('nuevaContrasena')?.errors?.['sinMayuscula']">
            Debe llevar una mayúscula
          </span>
          <span *ngIf="formularioNuevaContrasena.get('nuevaContrasena')?.value && formularioNuevaContrasena.get('nuevaContrasena')?.errors?.['sinNumero']">
            Debe llevar un número
          </span>
          <span *ngIf="formularioNuevaContrasena.get('nuevaContrasena')?.value && formularioNuevaContrasena.get('nuevaContrasena')?.errors?.['sinCaracterEspecial']">
            Debe llevar un carácter especial
          </span>
        </div>

        <ion-item class="campo-formulario">
          <ion-label position="stacked">Confirmar Contraseña</ion-label>
          <ion-input 
            [type]="mostrarConfirmarContrasena ? 'text' : 'password'" 
            formControlName="confirmarContrasena"
            placeholder="Confirma tu nueva contraseña">
          </ion-input>
          <ion-button 
            fill="clear" 
            slot="end" 
            (click)="alternarVisibilidadConfirmarContrasena()"
            class="boton-ojo">
            <ion-icon [name]="mostrarConfirmarContrasena ? 'eye-off' : 'eye'"></ion-icon>
          </ion-button>
        </ion-item>
        <div *ngIf="formularioNuevaContrasena.get('confirmarContrasena')?.invalid && formularioNuevaContrasena.get('confirmarContrasena')?.touched" 
             class="mensaje-error">
          <span *ngIf="formularioNuevaContrasena.get('confirmarContrasena')?.errors?.['required']">
            Debes confirmar la contraseña
          </span>
          <span *ngIf="formularioNuevaContrasena.get('confirmarContrasena')?.errors?.['noCoinciden']">
            Las contraseñas no coinciden
          </span>
        </div>

        <ion-button 
          expand="block" 
          type="submit" 
          class="boton-restablecer"
          [disabled]="formularioNuevaContrasena.invalid || estaCargando || !tokenValido">
          <span *ngIf="!estaCargando">Restablecer Contraseña</span>
          <span *ngIf="estaCargando">Restableciendo...</span>
        </ion-button>

        <div class="link-login">
          <a routerLink="/iniciar-sesion">Volver al inicio de sesión</a>
        </div>

      </form>
    </div>

    
    <div *ngIf="tokenVerificado && !tokenValido && !contrasenaCambiada" class="token-invalido">
      <h2 class="titulo-error">Enlace Inválido o Expirado</h2>
      <p class="mensaje-error-token">
        El enlace de recuperación no es válido o ha expirado. Los enlaces de recuperación expiran después de 1 hora.
      </p>
      <p class="instrucciones-error">
        Por favor, solicita un nuevo enlace de recuperación.
      </p>
      <ion-button 
        expand="block" 
        class="boton-solicitar-nuevo"
        routerLink="/recuperar-contrasena">
        Solicitar Nuevo Enlace
      </ion-button>
    </div>

    <div *ngIf="contrasenaCambiada" class="confirmacion-cambiada">
      <div class="icono-exito">
        <ion-icon name="checkmark-circle" size="large"></ion-icon>
      </div>
      <h2 class="titulo-confirmacion">Contraseña Restablecida</h2>
      <p class="mensaje-confirmacion">
        Tu contraseña ha sido restablecida exitosamente.
      </p>
      <p class="instrucciones">
        Serás redirigido al inicio de sesión en unos segundos.
      </p>
    </div>

  </div>
</ion-content>
