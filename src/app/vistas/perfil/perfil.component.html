<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-button fill="clear" slot="end" (click)="cerrarSesion()" class="boton-cerrar-sesion-header">
      <ion-icon name="log-out" slot="start"></ion-icon>
      <span>Cerrar Sesión</span>
    </ion-button>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="contenido-perfil" [scrollY]="true">
  <div class="ion-padding contenedor-perfil">
    <h1 class="titulo-perfil">Mi Perfil</h1>
    
    
    <div *ngIf="verificandoAuth" class="cargando">
      <p>Verificando autenticación...</p>
    </div>
    
    
    <div *ngIf="estaCargando && !datosUsuario && !verificandoAuth" class="cargando">
      <p>Cargando datos...</p>
    </div>
    
    
    <div *ngIf="datosUsuario && !verificandoAuth">
      
      
      <div class="seccion-perfil">
        <h2 class="titulo-seccion">Datos Personales</h2>
        
        <div *ngIf="!editandoDatos && !editandoEmpresa && !editandoTelefono" class="datos-visualizacion">
          <div class="campo-dato">
            <span class="label-dato">Nombre:</span>
            <span class="valor-dato">{{ datosUsuario.nombre || 'No especificado' }}</span>
          </div>
          <div class="campo-dato">
            <span class="label-dato">Email:</span>
            <span class="valor-dato">{{ datosUsuario.email || 'No especificado' }}</span>
          </div>
          <div class="campo-dato" *ngIf="datosUsuario.nombreEmpresa">
            <span class="label-dato">Nombre de Empresa:</span>
            <span class="valor-dato">{{ datosUsuario.nombreEmpresa }}</span>
          </div>
          <div class="campo-dato" *ngIf="datosUsuario.telefono">
            <span class="label-dato">Teléfono:</span>
            <span class="valor-dato">{{ datosUsuario.telefono }}</span>
          </div>
          <ion-button fill="outline" size="small" (click)="editandoDatos = true" class="boton-editar">
            Cambiar Nombre
          </ion-button>
        </div>
        
        <form [formGroup]="formularioDatos" *ngIf="editandoDatos" class="formulario-edicion">
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Nombre</ion-label>
            <ion-input type="text" formControlName="nombre" placeholder="Tu nombre"></ion-input>
          </ion-item>
          <div class="mensaje-error" *ngIf="formularioDatos.get('nombre')?.invalid && formularioDatos.get('nombre')?.touched">
            El nombre es requerido
          </div>
          
          <ion-button expand="block" (click)="guardarDatos()" [disabled]="formularioDatos.invalid || estaCargando" class="boton-guardar">
            Guardar
          </ion-button>
          <ion-button expand="block" fill="outline" (click)="editandoDatos = false" class="boton-cancelar">
            Cancelar
          </ion-button>
        </form>
      </div>
      
      
      <div class="seccion-perfil">
        <h2 class="titulo-seccion">Datos de Empresa</h2>
        
        <div *ngIf="!editandoEmpresa" class="datos-visualizacion">
          <div class="campo-dato" *ngIf="datosUsuario.nombreEmpresa">
            <span class="label-dato">Nombre de Empresa:</span>
            <span class="valor-dato">{{ datosUsuario.nombreEmpresa }}</span>
          </div>
          <div class="campo-dato" *ngIf="datosUsuario.rutEmpresa">
            <span class="label-dato">RUT:</span>
            <span class="valor-dato">{{ datosUsuario.rutEmpresa }}</span>
          </div>
          <div class="campo-dato" *ngIf="datosUsuario.razonSocial">
            <span class="label-dato">Razón Social:</span>
            <span class="valor-dato">{{ datosUsuario.razonSocial }}</span>
          </div>
          <div class="campo-dato" *ngIf="datosUsuario.giro">
            <span class="label-dato">Giro:</span>
            <span class="valor-dato">{{ datosUsuario.giro }}</span>
          </div>
          <div class="campo-dato" *ngIf="datosUsuario.correoEmpresa">
            <span class="label-dato">Correo:</span>
            <span class="valor-dato">{{ datosUsuario.correoEmpresa }}</span>
          </div>
          <div class="campo-dato" *ngIf="datosUsuario.direccionEmpresa">
            <span class="label-dato">Dirección:</span>
            <span class="valor-dato">{{ datosUsuario.direccionEmpresa }}</span>
          </div>
          <div class="campo-dato" *ngIf="datosUsuario.telefonoEmpresa">
            <span class="label-dato">Teléfono:</span>
            <span class="valor-dato">{{ datosUsuario.telefonoEmpresa }}</span>
          </div>
          <ion-button fill="outline" size="small" (click)="editandoEmpresa = true" class="boton-editar">
            {{ datosUsuario.nombreEmpresa ? 'Editar' : 'Agregar' }} Empresa
          </ion-button>
        </div>
        
        <form [formGroup]="formularioEmpresa" *ngIf="editandoEmpresa" class="formulario-edicion">
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Nombre de Empresa</ion-label>
            <ion-input type="text" formControlName="nombreEmpresa" placeholder="Nombre de tu empresa"></ion-input>
          </ion-item>
          
          <ion-item class="campo-formulario">
            <ion-label position="stacked">RUT</ion-label>
            <ion-input 
              type="text" 
              formControlName="rut"
              placeholder="12.345.678-9 (opcional)"
              (ionInput)="formatearRutInput($event)">
            </ion-input>
          </ion-item>
          <div *ngIf="formularioEmpresa.get('rut')?.invalid && formularioEmpresa.get('rut')?.touched" 
               class="mensaje-error">
            El RUT no es válido
          </div>
          
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Razón Social</ion-label>
            <ion-input type="text" formControlName="razonSocial" placeholder="Razón social (opcional)"></ion-input>
          </ion-item>
          
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Giro</ion-label>
            <ion-input type="text" formControlName="giro" placeholder="Giro comercial (opcional)"></ion-input>
          </ion-item>
          
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Correo</ion-label>
            <ion-input type="email" formControlName="correo" placeholder="correo@empresa.com (opcional)"></ion-input>
          </ion-item>
          <div *ngIf="formularioEmpresa.get('correo')?.invalid && formularioEmpresa.get('correo')?.touched" 
               class="mensaje-error">
            El correo no es válido
          </div>
          
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Dirección</ion-label>
            <ion-input type="text" formControlName="direccion" placeholder="Dirección (opcional)"></ion-input>
          </ion-item>
          
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Teléfono</ion-label>
            <ion-input type="tel" formControlName="telefono" placeholder="+56 9 1234 5678 (opcional)"></ion-input>
          </ion-item>
          <div *ngIf="formularioEmpresa.get('telefono')?.invalid && formularioEmpresa.get('telefono')?.touched" 
               class="mensaje-error">
            El teléfono no es válido
          </div>
          
          <ion-button expand="block" (click)="guardarEmpresa()" [disabled]="estaCargando || formularioEmpresa.invalid" class="boton-guardar">
            Guardar
          </ion-button>
          <ion-button expand="block" fill="outline" (click)="editandoEmpresa = false" class="boton-cancelar">
            Cancelar
          </ion-button>
        </form>
      </div>
      
      
      <div class="seccion-perfil">
        <h2 class="titulo-seccion">Teléfono</h2>
        
        <div *ngIf="!editandoTelefono" class="datos-visualizacion">
          <div class="campo-dato">
            <span class="label-dato">Teléfono:</span>
            <span class="valor-dato">{{ datosUsuario.telefono || 'No especificado' }}</span>
          </div>
          <ion-button fill="outline" size="small" (click)="editandoTelefono = true" class="boton-editar">
            {{ datosUsuario.telefono ? 'Editar' : 'Agregar' }} Teléfono
          </ion-button>
        </div>
        
        <form [formGroup]="formularioTelefono" *ngIf="editandoTelefono" class="formulario-edicion">
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Teléfono</ion-label>
            <ion-input type="tel" formControlName="telefono" placeholder="+56 9 1234 5678"></ion-input>
          </ion-item>
          <div class="mensaje-error" *ngIf="formularioTelefono.get('telefono')?.invalid && formularioTelefono.get('telefono')?.touched">
            Ingresa un teléfono válido
          </div>
          
          <ion-button expand="block" (click)="guardarTelefono()" [disabled]="formularioTelefono.invalid || estaCargando" class="boton-guardar">
            Guardar
          </ion-button>
          <ion-button expand="block" fill="outline" (click)="editandoTelefono = false" class="boton-cancelar">
            Cancelar
          </ion-button>
        </form>
      </div>
      
      
      <div class="seccion-perfil">
        <h2 class="titulo-seccion">Cambiar Email</h2>
        
        <div *ngIf="!editandoEmail" class="datos-visualizacion">
          <div class="campo-dato">
            <span class="label-dato">Email:</span>
            <span class="valor-dato">{{ datosUsuario.email || 'No especificado' }}</span>
          </div>
          <ion-button fill="outline" size="small" (click)="editandoEmail = true" class="boton-editar">
            Cambiar Email
          </ion-button>
        </div>
        
        <form [formGroup]="formularioEmail" *ngIf="editandoEmail" class="formulario-edicion">
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Contraseña Actual</ion-label>
            <ion-input type="password" formControlName="contrasenaActual" placeholder="Ingresa tu contraseña actual"></ion-input>
          </ion-item>
          <div class="mensaje-error" *ngIf="formularioEmail.get('contrasenaActual')?.invalid && formularioEmail.get('contrasenaActual')?.touched">
            La contraseña actual es requerida
          </div>
          
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Nuevo Email</ion-label>
            <ion-input type="email" formControlName="nuevoEmail" placeholder="nuevo@email.com"></ion-input>
          </ion-item>
          <div class="mensaje-error" *ngIf="formularioEmail.get('nuevoEmail')?.invalid && formularioEmail.get('nuevoEmail')?.touched">
            <span *ngIf="formularioEmail.get('nuevoEmail')?.errors?.['required']">El email es requerido</span>
            <span *ngIf="formularioEmail.get('nuevoEmail')?.errors?.['email']">Email inválido</span>
          </div>
          
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Confirmar Email</ion-label>
            <ion-input type="email" formControlName="confirmarEmail" placeholder="Confirma el nuevo email"></ion-input>
          </ion-item>
          <div class="mensaje-error" *ngIf="formularioEmail.get('confirmarEmail')?.invalid && formularioEmail.get('confirmarEmail')?.touched">
            <span *ngIf="formularioEmail.get('confirmarEmail')?.errors?.['required']">Confirma el email</span>
            <span *ngIf="formularioEmail.get('confirmarEmail')?.errors?.['emailsNoCoinciden']">Los emails no coinciden</span>
          </div>
          
          <ion-button expand="block" (click)="guardarEmail()" [disabled]="formularioEmail.invalid || estaCargando" class="boton-guardar">
            Guardar
          </ion-button>
          <ion-button expand="block" fill="outline" (click)="editandoEmail = false; formularioEmail.reset()" class="boton-cancelar">
            Cancelar
          </ion-button>
        </form>
      </div>
      
      
      <div class="seccion-perfil">
        <h2 class="titulo-seccion">Cambiar Contraseña</h2>
        
        <div *ngIf="!editandoPassword" class="datos-visualizacion">
          <div class="campo-dato">
            <span class="label-dato">Contraseña:</span>
            <span class="valor-dato password-oculta">••••••••</span>
          </div>
          <ion-button fill="outline" size="small" (click)="editandoPassword = true" class="boton-editar">
            Cambiar Contraseña
          </ion-button>
        </div>
        
        <form [formGroup]="formularioPassword" *ngIf="editandoPassword" class="formulario-edicion">
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Contraseña Actual</ion-label>
            <ion-input [type]="mostrarPasswordActual ? 'text' : 'password'" formControlName="contrasenaActual" placeholder="Ingresa tu contraseña actual"></ion-input>
            <ion-button fill="clear" slot="end" (click)="alternarVisibilidadPasswordActual()" class="boton-ojo">
              <ion-icon [name]="mostrarPasswordActual ? 'eye-off' : 'eye'"></ion-icon>
            </ion-button>
          </ion-item>
          <div class="mensaje-error" *ngIf="formularioPassword.get('contrasenaActual')?.invalid && formularioPassword.get('contrasenaActual')?.touched">
            La contraseña actual es requerida
          </div>
          
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Nueva Contraseña</ion-label>
            <ion-input [type]="mostrarPasswordNueva ? 'text' : 'password'" formControlName="contrasenaNueva" placeholder="Mínimo 6 caracteres"></ion-input>
            <ion-button fill="clear" slot="end" (click)="alternarVisibilidadPasswordNueva()" class="boton-ojo">
              <ion-icon [name]="mostrarPasswordNueva ? 'eye-off' : 'eye'"></ion-icon>
            </ion-button>
          </ion-item>
          <div class="mensaje-error" *ngIf="formularioPassword.get('contrasenaNueva')?.invalid && formularioPassword.get('contrasenaNueva')?.touched">
            <span *ngIf="formularioPassword.get('contrasenaNueva')?.errors?.['required']">La nueva contraseña es requerida</span>
            <span *ngIf="formularioPassword.get('contrasenaNueva')?.errors?.['minlength']">Mínimo 6 caracteres</span>
          </div>
          
          <ion-item class="campo-formulario">
            <ion-label position="stacked">Confirmar Nueva Contraseña</ion-label>
            <ion-input [type]="mostrarPasswordConfirmar ? 'text' : 'password'" formControlName="contrasenaConfirmar" placeholder="Confirma la nueva contraseña"></ion-input>
            <ion-button fill="clear" slot="end" (click)="alternarVisibilidadPasswordConfirmar()" class="boton-ojo">
              <ion-icon [name]="mostrarPasswordConfirmar ? 'eye-off' : 'eye'"></ion-icon>
            </ion-button>
          </ion-item>
          <div class="mensaje-error" *ngIf="formularioPassword.get('contrasenaConfirmar')?.invalid && formularioPassword.get('contrasenaConfirmar')?.touched">
            <span *ngIf="formularioPassword.get('contrasenaConfirmar')?.errors?.['required']">Confirma la contraseña</span>
            <span *ngIf="formularioPassword.get('contrasenaConfirmar')?.errors?.['contrasenasNoCoinciden']">Las contraseñas no coinciden</span>
          </div>
          
          <ion-button expand="block" (click)="guardarPassword()" [disabled]="formularioPassword.invalid || estaCargando" class="boton-guardar">
            Guardar
          </ion-button>
          <ion-button expand="block" fill="outline" (click)="editandoPassword = false; formularioPassword.reset()" class="boton-cancelar">
            Cancelar
          </ion-button>
        </form>
      </div>
      
      
      <div class="seccion-perfil">
        <h2 class="titulo-seccion">Plan y Membresía</h2>
        
        <div class="datos-visualizacion">
          <div class="campo-dato">
            <span class="label-dato">Plan Actual:</span>
            <span class="valor-dato plan-badge" [class.plan-free]="planActual === 'free'" [class.plan-plus]="planActual === 'plus'">
              {{ planActual === 'plus' ? 'Plus' : 'Free' }}
            </span>
          </div>
          
          <div *ngIf="fechaVencimiento" class="campo-dato">
            <span class="label-dato">Vence en:</span>
            <span class="valor-dato">{{ calcularTiempoRestante() }}</span>
          </div>
          
          <div *ngIf="fechaVencimiento" class="campo-dato">
            <span class="label-dato">Fecha de vencimiento:</span>
            <span class="valor-dato">{{ formatearFecha(fechaVencimiento) }}</span>
          </div>
          
          <ion-button expand="block" fill="outline" routerLink="/gestion-suscripcion" class="boton-renovar">
            Gestionar Suscripción
          </ion-button>
        </div>
      </div>
      
    </div>
    
    
    <ion-button expand="block" (click)="volverAtras()" class="boton-volver-inferior">
      <ion-icon name="arrow-back" slot="start"></ion-icon>
      <span>Volver</span>
    </ion-button>
  </div>
</ion-content>
